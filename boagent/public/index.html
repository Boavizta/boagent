<html xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html">

<head>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <link rel="stylesheet" href="assets/main.css" />
    <link rel="stylesheet" href="assets/table-style.css" />
    <script type="text/javascript" src="assets/dygraph.min.js"></script>
    <script type="text/javascript" src="assets/synchronizer.js"></script>
    <script type="text/javascript" src="assets/pureknob.js"></script>
</head>

<body style="background-color: #262B30; color: white; font-family: Ubuntu, sans-serif">
    <span id="forkongithub"><a href="https://github.com/Boavizta/boagent">Fork me on GitHub</a></span>
    <div class="scores-box">
        <h1>PLATYPUS : report, understand and tackle IT impacts</h1>
    </div>
    <div class="scores-box navbar">
        <a href="https://github.com/Green-Software-Foundation/carbon-aware-sdk" target="_blank">Carbon Aware API ðŸ”—</a>
        <a href="https://github.com/Boavizta/boagent/tree/greenhack22" target="_blank">Boagent ðŸ”—</a>
        <a href="https://github.com/Boavizta/boaviztapi/tree/greenhack22" target="_blank">BoaviztAPI ðŸ”—</a>
        <a href="https://github.com/Hubblo-org/scaphandre/tree/greenhack22" target="_blank">Scaphandre ðŸ”—</a>
    </div>

    <div class="scores-box">
        <div class="score-box">
            <h3>Actual intensity (CO2eq./kWh)</h3>
            <div id="actual_intensity"></div>
        </div>

        <div class="score-box">
            <h3>Actual RAM consumption</h3>
            <div id="actual_ram"></div>
        </div>

        <img id="platypus-logo" src="assets/platypus_logo.png" alt="platypus logo">

        <div class="score-box">
            <h3>Actual CPU consumption</h3>
            <div id="actual_cpu"></div>
        </div>
        <div class="score-box">
            <h3>Actual electrical consumption</h3>
            <div id="actual_elec"></div>
        </div>
    </div>

    <div class="impacts_box">
        <div class="impact_box">
            <h2>Yearly operational consumption</h2>
            <span class="txt_impact">120</span>
            <span class="txt_unit">kgCO2eq.</span>
        </div>
        <div class="impact_box">
            <h2>Yearly embedded consumption</h2>
            <span class="txt_impact">300</span>
            <span class="txt_unit">kgCO2eq.</span>
        </div>
    </div>



    <div class="box-legend">
        <h3>Carbon intensity</h3>
        <p>Carbon intensity in your region express in gCO2eq./kWh. </p>
    </div>
    <div class="box">
        <div id="graphintensity" style="width:100%;height:200px;"></div>
    </div>

    <div class="box-legend">
        <h3>Server impact</h3>
        <p>Green gaz emissions express in gCO2eq. Both operational (related to electricity consumption) and embedded (related to manufacture) are reported.</p>
    </div>
    <div class="box">
        <div id="graphimpact" style="width:100%;; height:200px;"></div>
    </div>

    <div class="box-legend">
        <h3>Server consumption</h3>
        <p>Consumption of the server in milliwatts</p>
    </div>
    <div class="box">
        <div id="graphconso" style="width:100%;; height:200px;"></div>
    </div>

    <div class="box-legend">
        <h3>Server Ram Usage</h3>
        <p>Ram usage of the machine in GigaBytes</p>
    </div>
    <div class="box">
        <div id="graphram" style="width:100%;; height:200px;"></div>
    </div>

    <div class="box-legend">
        <h3>Server Cpu Usage</h3>
        <p>Cpu usage of the machine in %</p>
    </div>
    <div class="box">
        <div id="graphcpu" style="width:100%;; height:200px;"></div>
    </div>


    <div class="box-legend">
        <h3>Recommandations</h3>
    </div>
    <table>
        <thead>
            <tr>
                <th></th>
                <th>Mode</th>
                <th>Time</th>
                <th>Type</th>
                <th>Recommendation</th>
                <th>CMD</th>
            </tr>
        <thead>
        <tbody  id="reco-table">
        </tbody>
    </table>


<script>
    fetch("/update")

    const actual_intensity = pureknob.createKnob(300, 180);
    actual_intensity.setProperty('angleStart', -0.75 * Math.PI);
    actual_intensity.setProperty('angleEnd', 0.75 * Math.PI);
    actual_intensity.setProperty('colorFG', '#ff7800');
    actual_intensity.setProperty('valMin', 0);
    actual_intensity.setProperty('valMax', 1000);
    actual_intensity.setProperty('readonly', true)
    document.getElementById('actual_intensity').appendChild(actual_intensity.node());
    actual_intensity.setProperty('fnValueToString', function(value) {
        let string = value.toString();
        return string + ' g';
    });


    const actual_ram = pureknob.createKnob(300, 180);
    actual_ram.setProperty('angleStart', -0.75 * Math.PI);
    actual_ram.setProperty('angleEnd', 0.75 * Math.PI);
    actual_ram.setProperty('colorFG', '#0078ff');
    actual_ram.setProperty('valMin', 0);
    actual_ram.setProperty('valMax', 100);
    actual_ram.setProperty('readonly', true)
    document.getElementById('actual_ram').appendChild(actual_ram.node());
    actual_ram.setProperty('fnValueToString', function(value) {
        let string = value.toString();
        return string + ' GB';
    });

    const actual_cpu = pureknob.createKnob(300, 180);
    actual_cpu.setProperty('angleStart', -0.75 * Math.PI);
    actual_cpu.setProperty('angleEnd', 0.75 * Math.PI);
    actual_cpu.setProperty('colorFG', '#88ff88');
    actual_cpu.setProperty('valMin', 0);
    actual_cpu.setProperty('valMax', 100);
    actual_cpu.setProperty('readonly', true)
    actual_cpu.setValue(12);
    document.getElementById('actual_cpu').appendChild(actual_cpu.node());
    actual_cpu.setProperty('fnValueToString', function(value) {
        let string = value.toString();
        return string + ' %';
    });

    const actual_elec = pureknob.createKnob(300, 180);
    actual_elec.setProperty('angleStart', -0.75 * Math.PI);
    actual_elec.setProperty('angleEnd', 0.75 * Math.PI);
    actual_elec.setProperty('colorFG', '#faf875');
    actual_elec.setProperty('valMin', 0);
    actual_elec.setProperty('valMax', 2000);
    actual_elec.setProperty('readonly', true)
    document.getElementById('actual_elec').appendChild(actual_elec.node());
    actual_elec.setProperty('fnValueToString', function(value) {
        let string = value.toString();
        return string + ' W';
    });

    fetch("/last_info")
        .then((response) => {
            return response.json();
        })
        .then((data) => {
            actual_intensity.setValue(data["carbonintensity"]["value"]);
            actual_ram.setValue(data["ram"]["value"]);
            actual_cpu.setValue(data["cpu"]["value"]);
            actual_elec.setValue(data["power"]["value"]*0.001);
        })
    fetch("/max_info")
        .then((response) => {
            return response.json();
        })
        .then((data) => {
            actual_intensity.setProperty('valMax', data["carbonintensity"]["value"]);
            actual_ram.setProperty('valMax', Math.ceil(data["ram"]["value"]));
            actual_elec.setProperty('valMax', data["power"]["value"]*0.001);
        })
</script>
<script>
    var duration="24"+"h"
    var graphintensity = new Dygraph(
        document.getElementById("graphintensity"),
        "/carbon_intensity?since=now&until="+duration, // path to CSV file
        {
            colors: ["rgba(0, 120, 255, 1)"],
            fillGraph: true,
            visibility: [true, false],
            underlayCallback: function(canvas, area, g) {
                function highlight_period(x_start, x_end) {
                    var canvas_left_x = g.toDomXCoord(x_start);
                    var canvas_right_x = g.toDomXCoord(x_end);
                    var canvas_width = canvas_right_x - canvas_left_x;
                    canvas.fillRect(canvas_left_x, area.y, canvas_width, area.h);
                }

                for (let i = 0; i < g.numRows(); i++) {
                    if (g.getValue(i, 2) === -1){
                        for (let j = i; j < g.numRows(); j++) {
                            if (g.getValue(j, 2) !== -1){
                                canvas.fillStyle = "rgba(120,255,120, 0.14)";
                                highlight_period(g.getValue(i, 0),g.getValue(j, 0));
                                i = j-1
                                break;
                            }
                        }
                    }
                    else if (g.getValue(i, 2) === 1){
                        for (let j = i+1; j < g.numRows(); j++) {
                            if (g.getValue(j, 2) !== 1){
                                canvas.fillStyle =  "rgba(255, 120, 120, 0.15)";
                                highlight_period(g.getValue(i, 0),g.getValue(j, 0));
                                i = j-1
                                break;
                            }
                        }
                    }
                }
            }
        });

    var graphimpact = new Dygraph(
        document.getElementById("graphimpact"),
        "/impact?since=now&until="+duration,
        {
            colors: ["rgba(0, 120, 255, 1)", "rgba(255, 120, 0, 1)"],
            fillGraph: true,
            visibility: [true, true]
        }
    );

        var graphconso = new Dygraph(
        document.getElementById("graphconso"),
        "/csv?data=power&since=now&until="+duration, // path to CSV file
        {
            fillGraph: true,
            visibility: [true, false]});

        var graphram = new Dygraph(
        document.getElementById("graphram"),
        "/csv?data=ram&until=now&since="+duration, // path to CSV file
        {
            colors: ["rgba(255, 120, 0, 1)"],
            fillGraph: true,
            visibility: [true, false]});

        var graphcpu = new Dygraph(
        document.getElementById("graphcpu"),
        "/csv?data=cpu&until=now&since="+duration, // path to CSV file
        {
            colors: ["rgba(0, 120, 255, 1)"],
            fillGraph: true,
            visibility: [true, false]
        });

    Dygraph.synchronize([graphintensity, graphconso, graphram, graphcpu, graphimpact], {
        zoom: true,
        selection: true,
        range: false
    });
</script>

<script>
    fetch("/recommendation")
        .then((response) => {
            return response.json();
        })
        .then((data) => {
            loadTableData(data);
        })

    function loadTableData(items) {
        const table = document.getElementById("reco-table");
        items.forEach( item => {
            let row = table.insertRow();

            let picto = row.insertCell(0);
            picto.innerHTML = "ðŸ•";

            let mode = row.insertCell(1);
            mode.innerHTML = item.mode

            let time = row.insertCell(2);
            time.innerHTML = item.execution_date;

            let type = row.insertCell(3);
            type.innerHTML = item.type;

            let reco = row.insertCell(4);
            reco.innerHTML = "Schedule your CRON during less carbonate hours (" + item.preferred_execution_date + ")"

            length = 45
            let job = row.insertCell(5);
            job.innerHTML = item.job.length > length ?
                item.job.substring(0, length - 3) + "..." :
                item.job;
        });
    }
</script>


</body>
</html>

